generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ConversationRole {
  PATIENT
  AI
  PHYSICIAN
}

enum VitalType {
  BLOOD_PRESSURE_SYSTOLIC
  BLOOD_PRESSURE_DIASTOLIC
  HEART_RATE
  WEIGHT
  GLUCOSE
  OXYGEN_SATURATION
  TEMPERATURE
}

// ─── Source Attribution Enums ─────────────────────────────────
// Per Albert + Manny joint spec: every structured clinical datum
// gets source tracking for safety and audit compliance.

enum SourceType {
  PATIENT_SMS       // Patient reported via text message
  PATIENT_VOICE     // Patient reported via phone call
  PATIENT_PORTAL    // Patient entered via web portal
  CLINICIAN         // Physician or clinical staff entered
  DEVICE            // Connected device (BP cuff, scale, etc.)
  EMR_IMPORT        // Imported from EMR paste
  AI_EXTRACTED      // AI extracted from conversation
  SYSTEM            // System-generated (cron, auto-calculation)
}

enum VerificationStatus {
  UNVERIFIED        // Not yet reviewed by physician
  VERIFIED          // Confirmed by physician
  DISPUTED          // Physician flagged as incorrect
  PENDING_REVIEW    // Queued for physician review (yellow flag)
}

model Patient {
  id             String   @id @default(cuid())
  clerkUserId    String   @unique
  organizationId String
  encMrn         String
  encFirstName   String
  encLastName    String
  encDateOfBirth String
  encSsn         String?
  encAddress     String?
  encPhone       String?
  encEmail       String?
  riskLevel      String   @default("MEDIUM")
  primaryDx      String?
  encConditions  String
  agentEnabled           Boolean  @default(true)
  encCustomInstructions  String?  // Encrypted per-patient AI overrides (allergies, dietary, preferences)
  lastInteraction        DateTime?
  physicianId    String
  physician      Physician @relation(fields: [physicianId], references: [id])
  conversations  Conversation[]
  medications    Medication[]
  vitals         Vital[]
  alerts         Alert[]
  carePlans      CarePlan[]
  auditLogs      AuditLog[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  @@index([organizationId])
  @@index([physicianId])
  @@index([clerkUserId])
}

model ConditionTemplate {
  id                 String   @id @default(cuid())
  organizationId     String
  slug               String   // e.g. "heart-failure", "atrial-fibrillation"
  conditionName      String   // Display name: "Heart Failure"
  matchPatterns      String   // JSON array of match strings
  monitoringProtocol String   @db.Text
  redFlags           String   @db.Text
  yellowFlags        String   @db.Text
  commonQuestions    String   @db.Text
  medicationGuidance String   @db.Text
  conversationStyle  String   @db.Text
  active             Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  @@unique([organizationId, slug])
  @@index([organizationId])
}

model Physician {
  id             String   @id @default(cuid())
  clerkUserId    String   @unique
  organizationId String
  npi            String?  @unique
  specialty      String?
  encName        String
  patients       Patient[]
  carePlans      CarePlan[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  @@index([organizationId])
}

model Conversation {
  id          String           @id @default(cuid())
  patientId   String
  patient     Patient          @relation(fields: [patientId], references: [id])
  role        ConversationRole
  encContent  String
  audioUrl    String?
  tokensUsed  Int?
  modelVersion String?
  createdAt   DateTime         @default(now())
  @@index([patientId])
  @@index([createdAt])
}

model Medication {
  id           String   @id @default(cuid())
  patientId    String
  patient      Patient  @relation(fields: [patientId], references: [id])
  drugName     String
  dose         String
  frequency    String
  route        String   @default("oral")
  prescribedBy String
  startDate    DateTime
  endDate      DateTime?
  adherenceRate Float   @default(0)
  lastTaken    DateTime?
  encNotes     String?
  active       Boolean  @default(true)

  // ─── Source Attribution (Manny PR) ──────────────────────────
  sourceType          SourceType         @default(CLINICIAN)
  verificationStatus  VerificationStatus @default(UNVERIFIED)
  verifiedBy          String?            // clerkUserId of verifying physician
  verifiedAt          DateTime?
  sourceMessageId     String?            // conversation ID that reported this
  sourceConfidence    Int                @default(0)  // 0-3: 0=unknown, 1=low, 2=medium, 3=high

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  @@index([patientId])
  @@index([verificationStatus])
}

model Vital {
  id          String    @id @default(cuid())
  patientId   String
  patient     Patient   @relation(fields: [patientId], references: [id])
  type        VitalType
  encValue    String
  unit        String
  recordedAt  DateTime
  source      String

  // ─── Source Attribution (Manny PR) ──────────────────────────
  sourceType          SourceType         @default(PATIENT_SMS)
  verificationStatus  VerificationStatus @default(UNVERIFIED)
  verifiedBy          String?
  verifiedAt          DateTime?
  sourceConfidence    Int                @default(2)  // vitals usually medium confidence

  createdAt   DateTime  @default(now())
  @@index([patientId])
  @@index([type])
  @@index([recordedAt])
  @@index([verificationStatus])
}

model Alert {
  id            String        @id @default(cuid())
  patientId     String
  patient       Patient       @relation(fields: [patientId], references: [id])
  severity      AlertSeverity
  category      String
  encMessage    String
  triggerSource     String
  encPatientMessage String?         // Encrypted verbatim patient message that triggered the alert
  matchedKeywords   String?         // JSON array of matched emergency keywords (not PHI)
  resolved          Boolean  @default(false)
  resolvedBy    String?
  resolvedAt    DateTime?
  encResolution String?
  createdAt     DateTime      @default(now())
  @@index([patientId])
  @@index([severity])
  @@index([resolved])
}

model AuditLog {
  id             String   @id @default(cuid())
  userId         String
  action         String
  resource       String
  resourceId     String
  details        Json?
  ipAddress      String?
  userAgent      String?
  organizationId String?
  patientId      String?
  patient        Patient? @relation(fields: [patientId], references: [id])
  timestamp      DateTime @default(now())
  @@index([userId])
  @@index([timestamp])
  @@index([resource, resourceId])
  @@index([patientId])
}

model CarePlan {
  id          String    @id @default(cuid())
  patientId   String
  patient     Patient   @relation(fields: [patientId], references: [id])
  physicianId String
  physician   Physician @relation(fields: [physicianId], references: [id])
  encContent  String
  version     Int       @default(1)
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  @@index([patientId])
}
