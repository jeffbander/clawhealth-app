generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ConversationRole {
  PATIENT
  AI
  PHYSICIAN
}

enum VitalType {
  BLOOD_PRESSURE_SYSTOLIC
  BLOOD_PRESSURE_DIASTOLIC
  HEART_RATE
  WEIGHT
  GLUCOSE
  OXYGEN_SATURATION
  TEMPERATURE
}

model Patient {
  id             String   @id @default(cuid())
  clerkUserId    String   @unique
  organizationId String
  encMrn         String
  encFirstName   String
  encLastName    String
  encDateOfBirth String
  encSsn         String?
  encAddress     String?
  encPhone       String?
  encEmail       String?
  riskLevel      String   @default("MEDIUM")
  primaryDx      String?
  encConditions  String
  agentEnabled   Boolean  @default(true)
  lastInteraction DateTime?
  physicianId    String
  physician      Physician @relation(fields: [physicianId], references: [id])
  conversations  Conversation[]
  medications    Medication[]
  vitals         Vital[]
  alerts         Alert[]
  carePlans      CarePlan[]
  auditLogs      AuditLog[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  @@index([organizationId])
  @@index([physicianId])
  @@index([clerkUserId])
}

model Physician {
  id             String   @id @default(cuid())
  clerkUserId    String   @unique
  organizationId String
  npi            String?  @unique
  specialty      String?
  encName        String
  patients       Patient[]
  carePlans      CarePlan[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  @@index([organizationId])
}

model Conversation {
  id          String           @id @default(cuid())
  patientId   String
  patient     Patient          @relation(fields: [patientId], references: [id])
  role        ConversationRole
  encContent  String
  audioUrl    String?
  tokensUsed  Int?
  modelVersion String?
  createdAt   DateTime         @default(now())
  @@index([patientId])
  @@index([createdAt])
}

model Medication {
  id           String   @id @default(cuid())
  patientId    String
  patient      Patient  @relation(fields: [patientId], references: [id])
  drugName     String
  dose         String
  frequency    String
  route        String   @default("oral")
  prescribedBy String
  startDate    DateTime
  endDate      DateTime?
  adherenceRate Float   @default(0)
  lastTaken    DateTime?
  encNotes     String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  @@index([patientId])
}

model Vital {
  id          String    @id @default(cuid())
  patientId   String
  patient     Patient   @relation(fields: [patientId], references: [id])
  type        VitalType
  encValue    String
  unit        String
  recordedAt  DateTime
  source      String
  createdAt   DateTime  @default(now())
  @@index([patientId])
  @@index([type])
  @@index([recordedAt])
}

model Alert {
  id            String        @id @default(cuid())
  patientId     String
  patient       Patient       @relation(fields: [patientId], references: [id])
  severity      AlertSeverity
  category      String
  encMessage    String
  triggerSource String
  resolved      Boolean       @default(false)
  resolvedBy    String?
  resolvedAt    DateTime?
  encResolution String?
  createdAt     DateTime      @default(now())
  @@index([patientId])
  @@index([severity])
  @@index([resolved])
}

model AuditLog {
  id             String   @id @default(cuid())
  userId         String
  action         String
  resource       String
  resourceId     String
  details        Json?
  ipAddress      String?
  userAgent      String?
  organizationId String?
  patientId      String?
  patient        Patient? @relation(fields: [patientId], references: [id])
  timestamp      DateTime @default(now())
  @@index([userId])
  @@index([timestamp])
  @@index([resource, resourceId])
  @@index([patientId])
}

model CarePlan {
  id          String    @id @default(cuid())
  patientId   String
  patient     Patient   @relation(fields: [patientId], references: [id])
  physicianId String
  physician   Physician @relation(fields: [physicianId], references: [id])
  encContent  String
  version     Int       @default(1)
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  @@index([patientId])
}
