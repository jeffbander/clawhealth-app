name: Deploy ClawHealth

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Type Check & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma generate
      - run: npm run build
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

  deploy-vercel:
    name: Deploy to Vercel (app.clawmd.ai)
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm i -g vercel
      - run: vercel pull --yes --token=${{ secrets.VERCEL_TOKEN }}
      - run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      - run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

  deploy-cloudrun:
    name: Deploy Agent Server (GCP Cloud Run)
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: clawhealth-sa@sacred-evening-485804-u0.iam.gserviceaccount.com
      - uses: google-github-actions/setup-gcloud@v2
      - run: gcloud auth configure-docker us-east1-docker.pkg.dev --quiet
      - name: Build & Push Docker image
        run: |
          TAG=$(git rev-parse --short HEAD)
          REPO="us-east1-docker.pkg.dev/sacred-evening-485804-u0/clawhealth/app"
          docker build -t "$REPO:$TAG" -t "$REPO:latest" .
          docker push "$REPO:$TAG"
          docker push "$REPO:latest"
      - name: Deploy to Cloud Run
        run: |
          TAG=$(git rev-parse --short HEAD)
          gcloud run deploy clawhealth-agents \
            --image="us-east1-docker.pkg.dev/sacred-evening-485804-u0/clawhealth/app:$TAG" \
            --region=us-east1 \
            --platform=managed \
            --quiet
